- name: ðŸ“ˆ è¿è¡Œè¶‹åŠ¿çœ‹æ¿ (L4.5 ç»ˆæžç¡¬åŒ–ç‰ˆ)
  if: always()
  shell: bash
  run: |
   set +e
   FILE="run_history.jsonl"
   echo "### ðŸ­ å·¥åŽ‚è¿è¡Œè¶‹åŠ¿ (æœ€è¿‘ 7 æ¬¡åˆ†æž)" >> $GITHUB_STEP_SUMMARY

   # 1. å†·å¯åŠ¨æ‹¦æˆª
   if [ ! -s "$FILE" ]; then
    echo "> âš ï¸ æš‚æ— åŽ†å²æ•°æ®ã€‚ç³»ç»Ÿå°†åœ¨ä¸‹ä¸€æ¬¡æˆåŠŸè¿è¡ŒåŽè‡ªåŠ¨ç”Ÿæˆçœ‹æ¿ã€‚" >> $GITHUB_STEP_SUMMARY
    exit 0
   fi

   # 2. æ•°æ®æ¸…æ´—ä¸Žç¡¬åŒ– (è¿‡æ»¤éžæ³• JSON)
   RAW_7=$(tail -n 7 "$FILE")
   SAFE_7=$(echo "$RAW_7" | jq -c . 2>/dev/null || echo "")

   # 3. åŸºç¡€æŒ‡æ ‡æŠ“å– (0 ç®—æœ¯)
   RUN_COUNT=$(echo "$SAFE_7" | wc -l | xargs)
   FB_TOTAL=$(echo "$SAFE_7" | jq -s '[.[] | select(.fallback_used == true)] | length // 0')
   RETRY_TOTAL=$(echo "$SAFE_7" | jq -s 'map(.retry_count // 0) | add // 0')

   # 4. è¶‹åŠ¿åˆ¤æ–­é€»è¾‘ (å¯¹æ¯”æœ€è¿‘ 3 æ¬¡ vs å‰ 3 æ¬¡ï¼Œæ— é™¤æ³•)
   NEW_3=$(echo "$SAFE_7" | tail -n 3)
   NEW_RETRY=$(echo "$NEW_3" | jq -s 'map(.retry_count // 0) | add // 0')
   OLD_3=$(echo "$SAFE_7" | head -n -3 | tail -n 3)
   OLD_RETRY=$(echo "$OLD_3" | jq -s 'map(.retry_count // 0) | add // 0')

   # è¶‹åŠ¿ç®­å¤´é€»è¾‘
   TREND="âž–"
   if [ "$NEW_RETRY" -gt "$OLD_RETRY" ]; then TREND="ðŸ“ˆ æ³¢åŠ¨ä¸Šå‡"; fi
   if [ "$NEW_RETRY" -lt "$OLD_RETRY" ]; then TREND="ðŸ“‰ è¶‹äºŽå¹³ç¨³"; fi

   # 5. çº¯å±•ç¤ºçœ‹æ¿
   echo "| è§‚å¯Ÿç»´åº¦ | æ•°å€¼ (7æ—¥ç´¯ç§¯) | çŠ¶æ€/è¶‹åŠ¿ |" >> $GITHUB_STEP_SUMMARY
   echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
   echo "| **æ€»è¿è¡Œæ¬¡æ•°** | $RUN_COUNT | ðŸŸ¢ Active |" >> $GITHUB_STEP_SUMMARY
   echo "| **é™çº§è§¦å‘ (Fallback)** | $FB_TOTAL | $([ $FB_TOTAL -eq 0 ] && echo 'ðŸŸ¢ è‰¯å¥½' || echo 'ðŸŸ¡ éœ€å…³æ³¨') |" >> $GITHUB_STEP_SUMMARY
   echo "| **é‡è¯•åŽ‹åŠ›è¶‹åŠ¿** | $RETRY_TOTAL | $TREND |" >> $GITHUB_STEP_SUMMARY

   echo " " >> $GITHUB_STEP_SUMMARY
   echo "> ðŸ’¡ **è¿ç»´æç¤º**: è¶‹åŠ¿åŸºäºŽæœ€è¿‘ 3 æ¬¡è¿è¡Œä¸Žå‰ 3 æ¬¡çš„å¯¹æ¯”ã€‚è‹¥é‡è¯•æŒç»­ä¸Šå‡ï¼Œè¯·æ£€æŸ¥ API ç¨³å®šæ€§ã€‚" >> $GITHUB_STEP_SUMMARY
   exit 0
